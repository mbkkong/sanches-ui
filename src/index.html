<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;">
  <title>Sanches - Security Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cyber: {
              bg: '#0a0e27',
              surface: '#141b3d',
              accent: '#00ff9f',
              danger: '#ff0066',
              warning: '#ffaa00',
              text: '#e0e6ed',
            }
          }
        }
      }
    }
  </script>
  <style>
    @keyframes matrix {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 159, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 159, 0.8); }
    }
    
    @keyframes scan-line {
      0% { top: 0; }
      100% { top: 100%; }
    }

    .matrix-bg {
      position: fixed;
      inset: 0;
      opacity: 0.03;
      pointer-events: none;
      background: 
        linear-gradient(0deg, transparent 24%, rgba(0, 255, 159, 0.05) 25%, rgba(0, 255, 159, 0.05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 159, 0.05) 75%, rgba(0, 255, 159, 0.05) 76%, transparent 77%, transparent),
        linear-gradient(90deg, transparent 24%, rgba(0, 255, 159, 0.05) 25%, rgba(0, 255, 159, 0.05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 159, 0.05) 75%, rgba(0, 255, 159, 0.05) 76%, transparent 77%, transparent);
      background-size: 50px 50px;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(to bottom, transparent, rgba(0, 255, 159, 0.8), transparent);
      animation: scan-line 3s linear infinite;
      pointer-events: none;
    }

    .glow-text {
      text-shadow: 0 0 10px rgba(0, 255, 159, 0.8);
    }

    .card-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #141b3d;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff9f;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc7f;
    }
  </style>
</head>
<body class="bg-cyber-bg text-cyber-text font-mono overflow-hidden">
  <div class="matrix-bg"></div>
  
  <div class="relative min-h-screen flex flex-col">
    <!-- Header -->
    <header class="relative border-b border-cyber-accent/30 bg-cyber-surface/50 backdrop-blur-sm">
      <div class="scan-line"></div>
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-cyber-accent/10 rounded-lg flex items-center justify-center border border-cyber-accent/30">
              <span class="text-2xl glow-text">üõ°Ô∏è</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold glow-text text-cyber-accent">SANCHES</h1>
              <p class="text-xs text-cyber-text/60">Security Monitor v1.0</p>
            </div>
          </div>
          
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-cyber-accent rounded-full card-glow"></div>
              <span class="text-sm text-cyber-text/80">System Active</span>
            </div>
            <button id="runScanBtn" class="px-4 py-2 bg-cyber-accent/20 border border-cyber-accent/50 rounded-lg hover:bg-cyber-accent/30 transition-all text-cyber-accent text-sm font-semibold">
              ‚ö° Run Scan Now
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
      <div class="max-w-7xl mx-auto px-6 py-6 h-full flex flex-col gap-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-4 gap-4">
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-danger/30 rounded-lg p-4 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-cyber-danger/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-cyber-danger/60 text-xs uppercase tracking-wider mb-1">Critical</p>
              <p class="text-3xl font-bold text-cyber-danger" id="criticalCount">0</p>
            </div>
          </div>
          
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-warning/30 rounded-lg p-4 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-cyber-warning/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-cyber-warning/60 text-xs uppercase tracking-wider mb-1">Warnings</p>
              <p class="text-3xl font-bold text-cyber-warning" id="warningCount">0</p>
            </div>
          </div>
          
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-blue-400/30 rounded-lg p-4 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-blue-400/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-blue-400/60 text-xs uppercase tracking-wider mb-1">Dependencies</p>
              <p class="text-3xl font-bold text-blue-400" id="depsCount">0</p>
            </div>
          </div>
          
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-accent/30 rounded-lg p-4 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-cyber-accent/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-cyber-accent/60 text-xs uppercase tracking-wider mb-1">Last Scan</p>
              <p class="text-sm font-semibold text-cyber-accent" id="lastScan">--:--:--</p>
            </div>
          </div>
        </div>

        <!-- Working Directory -->
        <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-accent/20 rounded-lg p-4">
          <div class="flex items-center gap-2">
            <span class="text-cyber-accent/60 text-sm">üìÇ Monitoring:</span>
            <code class="text-cyber-accent text-sm font-mono" id="workingDir">...</code>
          </div>
        </div>

        <!-- Issues List -->
        <div class="flex-1 overflow-hidden flex flex-col min-h-0">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-cyber-accent glow-text">Security Issues</h2>
            <div class="flex gap-2 text-xs">
              <button class="filter-btn active px-3 py-1 rounded-full border" data-filter="all">All</button>
              <button class="filter-btn px-3 py-1 rounded-full border border-cyber-danger/30 text-cyber-danger" data-filter="critical">Critical</button>
              <button class="filter-btn px-3 py-1 rounded-full border border-cyber-warning/30 text-cyber-warning" data-filter="warning">Warnings</button>
              <button class="filter-btn px-3 py-1 rounded-full border border-blue-400/30 text-blue-400" data-filter="dependencies">Dependencies</button>
            </div>
          </div>
          
          <div class="flex-1 overflow-y-auto space-y-2 pr-2" id="issuesContainer" style="max-height: calc(100vh - 400px);">
            <!-- Issues will be dynamically inserted here -->
            <div class="text-center py-20 text-cyber-text/40">
              <div class="text-6xl mb-4">üîç</div>
              <p>Waiting for scan results...</p>
              <p class="text-sm mt-2">Scans run automatically every minute</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentFilter = 'all';
    let latestScanData = null;

    const criticalCountEl = document.getElementById('criticalCount');
    const warningCountEl = document.getElementById('warningCount');
    const depsCountEl = document.getElementById('depsCount');
    const lastScanEl = document.getElementById('lastScan');
    const workingDirEl = document.getElementById('workingDir');
    const issuesContainerEl = document.getElementById('issuesContainer');
    const runScanBtn = document.getElementById('runScanBtn');

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-cyber-accent/20', 'border-cyber-accent', 'text-cyber-accent'));
        btn.classList.add('active', 'bg-cyber-accent/20', 'border-cyber-accent', 'text-cyber-accent');
        currentFilter = btn.dataset.filter;
        if (latestScanData) {
          renderIssues(latestScanData);
        }
      });
    });

    // Run scan manually
    runScanBtn.addEventListener('click', async () => {
      runScanBtn.disabled = true;
      runScanBtn.innerHTML = '‚è≥ Scanning...';
      
      const result = await window.electronAPI.runScan();
      if (result) {
        handleScanResult(result);
      }
      
      runScanBtn.disabled = false;
      runScanBtn.innerHTML = '‚ö° Run Scan Now';
    });

    // Format file path for display
    function formatFilePath(filepath) {
      const parts = filepath.split('/');
      if (parts.length > 4) {
        return '.../' + parts.slice(-3).join('/');
      }
      return filepath;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Copy to clipboard function
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì';
        button.classList.add('bg-cyber-accent/30');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-cyber-accent/30');
        }, 1500);
      }).catch(err => {
        console.error('Failed to copy:', err);
        button.innerHTML = '‚úó';
        setTimeout(() => {
          button.innerHTML = 'üìã';
        }, 1500);
      });
    }

    // Render issues
    function renderIssues(data) {
      latestScanData = data;
      
      let issues = [];
      
      if (currentFilter === 'all' || currentFilter === 'critical') {
        issues.push(...(data.critical || []).map(item => ({ ...item, type: 'critical' })));
      }
      
      if (currentFilter === 'all' || currentFilter === 'warning') {
        issues.push(...(data.warning || []).map(item => ({ ...item, type: 'warning' })));
      }
      
      if (currentFilter === 'all' || currentFilter === 'dependencies') {
        issues.push(...(data.dependencies || []).map(item => ({ ...item, type: 'dependencies' })));
      }

      if (issues.length === 0) {
        issuesContainerEl.innerHTML = `
          <div class="text-center py-20 text-cyber-accent">
            <div class="text-6xl mb-4">‚úÖ</div>
            <p class="text-xl font-bold glow-text">All Clear!</p>
            <p class="text-sm mt-2 text-cyber-text/60">No ${currentFilter === 'all' ? '' : currentFilter} issues detected</p>
          </div>
        `;
        return;
      }

      issuesContainerEl.innerHTML = issues.map(issue => {
        const colors = {
          critical: { bg: 'bg-cyber-danger/5', border: 'border-cyber-danger/30', text: 'text-cyber-danger', badge: 'bg-cyber-danger/20' },
          warning: { bg: 'bg-cyber-warning/5', border: 'border-cyber-warning/30', text: 'text-cyber-warning', badge: 'bg-cyber-warning/20' },
          dependencies: { bg: 'bg-blue-400/5', border: 'border-blue-400/30', text: 'text-blue-400', badge: 'bg-blue-400/20' }
        }[issue.type];

        const icon = {
          critical: 'üö®',
          warning: '‚ö†Ô∏è',
          dependencies: 'üì¶'
        }[issue.type];

        if (issue.type === 'dependencies') {
          return `
            <div class="relative ${colors.bg} backdrop-blur-sm border ${colors.border} rounded-lg p-3 hover:${colors.border.replace('/30', '/50')} transition-all">
              <div class="flex items-start gap-2">
                <div class="text-xl">${icon}</div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="px-2 py-0.5 ${colors.badge} ${colors.text} text-xs font-bold uppercase rounded">
                      ${issue.type}
                    </span>
                    <span class="text-xs ${colors.text} opacity-60">${issue.package_type || 'N/A'}</span>
                  </div>
                  <p class="font-bold ${colors.text} text-sm mb-1">${issue.package || 'Unknown Package'}</p>
                  <p class="text-xs text-cyber-text/80 break-words">${issue.description || 'No description'}</p>
                </div>
              </div>
            </div>
          `;
        }

        return `
          <div class="relative ${colors.bg} backdrop-blur-sm border ${colors.border} rounded-lg p-3 hover:${colors.border.replace('/30', '/50')} transition-all">
            <div class="flex items-start gap-2">
              <div class="text-xl">${icon}</div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2 group">
                  <span class="px-2 py-0.5 ${colors.badge} ${colors.text} text-xs font-bold uppercase rounded shrink-0">
                    ${issue.type}
                  </span>
                  <p class="text-xs text-cyber-text/60 font-mono truncate flex-1" title="${issue.file}">
                    üìÑ ${formatFilePath(issue.file || 'Unknown file')}
                  </p>
                  <button 
                    onclick="copyToClipboard('${escapeHtml(issue.file || '')}', this)" 
                    class="opacity-0 group-hover:opacity-100 transition-opacity px-1.5 py-0.5 bg-cyber-accent/10 hover:bg-cyber-accent/20 border border-cyber-accent/30 rounded text-cyber-accent text-xs shrink-0"
                    title="Copy file path">
                    üìã
                  </button>
                </div>
                <p class="text-xs text-cyber-text/80 break-words">${issue.description || 'No description'}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Handle scan result
    function handleScanResult(data) {
      // Update counts
      criticalCountEl.textContent = data.critical?.length || 0;
      warningCountEl.textContent = data.warning?.length || 0;
      depsCountEl.textContent = data.dependencies?.length || 0;
      
      // Update last scan time
      const now = new Date();
      lastScanEl.textContent = now.toLocaleTimeString();
      
      // Update working directory
      if (data.pwd) {
        workingDirEl.textContent = data.pwd;
      }
      
      // Render issues
      renderIssues(data);
    }

    // Listen for scan results from main process
    window.electronAPI.onScanResult((data) => {
      console.log('Scan result received:', data);
      handleScanResult(data);
    });

    // Request initial scan
    setTimeout(async () => {
      const result = await window.electronAPI.runScan();
      if (result) {
        handleScanResult(result);
      }
    }, 1000);
  </script>
</body>
</html>
