<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;">
  <title>Sanches - Security Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cyber: {
              bg: '#0a0e27',
              surface: '#141b3d',
              accent: '#00ff9f',
              danger: '#ff0066',
              warning: '#ffaa00',
              text: '#e0e6ed',
            }
          }
        }
      }
    }
  </script>
  <style>
    @keyframes matrix {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 159, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 159, 0.8); }
    }
    
    @keyframes scan-line {
      0% { top: 0; }
      100% { top: 100%; }
    }

    .matrix-bg {
      position: fixed;
      inset: 0;
      opacity: 0.03;
      pointer-events: none;
      background: 
        linear-gradient(0deg, transparent 24%, rgba(0, 255, 159, 0.05) 25%, rgba(0, 255, 159, 0.05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 159, 0.05) 75%, rgba(0, 255, 159, 0.05) 76%, transparent 77%, transparent),
        linear-gradient(90deg, transparent 24%, rgba(0, 255, 159, 0.05) 25%, rgba(0, 255, 159, 0.05) 26%, transparent 27%, transparent 74%, rgba(0, 255, 159, 0.05) 75%, rgba(0, 255, 159, 0.05) 76%, transparent 77%, transparent);
      background-size: 50px 50px;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(to bottom, transparent, rgba(0, 255, 159, 0.8), transparent);
      animation: scan-line 3s linear infinite;
      pointer-events: none;
    }

    .glow-text {
      text-shadow: 0 0 10px rgba(0, 255, 159, 0.8);
    }

    .card-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #141b3d;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff9f;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc7f;
    }
  </style>
</head>
<body class="bg-cyber-bg text-cyber-text font-mono overflow-hidden">
  <div class="matrix-bg"></div>
  
  <div class="relative h-screen flex flex-col">
    <!-- Header -->
    <header class="relative border-b border-cyber-accent/30 bg-cyber-surface/50 backdrop-blur-sm">
      <div class="scan-line"></div>
      <div class="px-4 py-3">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-cyber-accent/10 rounded-lg flex items-center justify-center border border-cyber-accent/30">
              <span class="text-lg glow-text">üõ°Ô∏è</span>
            </div>
            <div>
              <h1 class="text-lg font-bold glow-text text-cyber-accent">SANCHES</h1>
              <p class="text-xs text-cyber-text/60">Security Monitor</p>
            </div>
          </div>
          
          <button id="runScanBtn" class="px-3 py-1.5 bg-cyber-accent/20 border border-cyber-accent/50 rounded-lg hover:bg-cyber-accent/30 transition-all text-cyber-accent text-xs font-semibold">
            ‚ö° Scan
          </button>
        </div>
        
        <div class="flex items-center gap-2 text-xs">
          <div class="flex items-center gap-1">
            <div class="w-1.5 h-1.5 bg-cyber-accent rounded-full card-glow" id="watchIndicator"></div>
            <span class="text-cyber-text/80" id="watchStatusText">Active</span>
          </div>
          <span class="text-cyber-text/40">‚Ä¢</span>
          <span class="text-cyber-text/60" id="lastScan">--:--:--</span>
          <span class="text-cyber-text/40">‚Ä¢</span>
          <button id="globalWatchToggle" class="px-2 py-0.5 bg-cyber-accent/20 border border-cyber-accent/50 rounded hover:bg-cyber-accent/30 transition-all text-cyber-accent font-semibold">
            Watch: ON
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
      <div class="px-4 py-3 h-full flex flex-col gap-3">
        <!-- Stats Cards -->
        <div class="grid grid-cols-3 gap-2">
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-danger/30 rounded-lg p-2 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-12 h-12 bg-cyber-danger/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-cyber-danger/60 text-xs uppercase tracking-wider">Critical</p>
              <p class="text-2xl font-bold text-cyber-danger" id="criticalCount">0</p>
            </div>
          </div>
          
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-warning/30 rounded-lg p-2 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-12 h-12 bg-cyber-warning/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-cyber-warning/60 text-xs uppercase tracking-wider">Warnings</p>
              <p class="text-2xl font-bold text-cyber-warning" id="warningCount">0</p>
            </div>
          </div>
          
          <div class="bg-cyber-surface/50 backdrop-blur-sm border border-blue-400/30 rounded-lg p-2 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-12 h-12 bg-blue-400/5 rounded-full blur-xl"></div>
            <div class="relative">
              <p class="text-blue-400/60 text-xs uppercase tracking-wider">Dependencies</p>
              <p class="text-2xl font-bold text-blue-400" id="depsCount">0</p>
            </div>
          </div>
        </div>

        <!-- Project Selector -->
        <div class="bg-cyber-surface/50 backdrop-blur-sm border border-cyber-accent/20 rounded-lg p-2">
          <div class="flex items-center gap-2">
            <span class="text-cyber-accent/60 text-xs">üìÇ</span>
            <select id="projectSelector" class="flex-1 bg-transparent text-cyber-accent text-xs font-mono border-none outline-none cursor-pointer">
              <option value="">No project selected</option>
            </select>
            <button id="addProjectBtn" class="px-2 py-0.5 bg-cyber-accent/10 hover:bg-cyber-accent/20 border border-cyber-accent/30 rounded text-cyber-accent text-xs" title="Add project">
              +
            </button>
            <button id="manageProjectsBtn" class="px-2 py-0.5 bg-cyber-accent/10 hover:bg-cyber-accent/20 border border-cyber-accent/30 rounded text-cyber-accent text-xs" title="Manage projects">
              ‚öôÔ∏è
            </button>
          </div>
        </div>

        <!-- Issues List -->
        <div class="flex-1 overflow-hidden flex flex-col min-h-0">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-sm font-bold text-cyber-accent glow-text">Issues</h2>
            <div class="flex gap-1 text-xs">
              <button class="filter-btn active px-2 py-0.5 rounded-full border text-xs" data-filter="all">All</button>
              <button class="filter-btn px-2 py-0.5 rounded-full border border-cyber-danger/30 text-cyber-danger text-xs" data-filter="critical">Critical</button>
              <button class="filter-btn px-2 py-0.5 rounded-full border border-cyber-warning/30 text-cyber-warning text-xs" data-filter="warning">Warn</button>
              <button class="filter-btn px-2 py-0.5 rounded-full border border-blue-400/30 text-blue-400 text-xs" data-filter="dependencies">Deps</button>
            </div>
          </div>
          
          <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="issuesContainer">
            <!-- Issues will be dynamically inserted here -->
            <div class="text-center py-20 text-cyber-text/40">
              <div class="text-6xl mb-4">üîç</div>
              <p>Waiting for scan results...</p>
              <p class="text-sm mt-2">Scans run automatically every minute</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Project Modal -->
  <div id="addProjectModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-cyber-surface border border-cyber-accent/30 rounded-lg p-4 w-80">
      <h3 class="text-lg font-bold text-cyber-accent mb-3">Add Project</h3>
      <div class="space-y-3">
        <div>
          <label class="text-xs text-cyber-text/60 block mb-1">Project Path</label>
          <input type="text" id="projectPath" class="w-full bg-cyber-bg border border-cyber-accent/30 rounded px-2 py-1.5 text-sm text-cyber-text font-mono outline-none focus:border-cyber-accent" placeholder="/path/to/project">
          <p class="text-xs text-cyber-text/40 mt-1">Folder name will be used as project name</p>
        </div>
        <div class="flex gap-2 mt-4">
          <button id="saveProjectBtn" class="flex-1 px-3 py-1.5 bg-cyber-accent/20 border border-cyber-accent rounded hover:bg-cyber-accent/30 text-cyber-accent text-sm font-semibold">
            Save
          </button>
          <button id="cancelProjectBtn" class="flex-1 px-3 py-1.5 bg-cyber-surface border border-cyber-text/20 rounded hover:bg-cyber-text/10 text-cyber-text text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Projects Modal -->
  <div id="manageProjectsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-cyber-surface border border-cyber-accent/30 rounded-lg p-4 w-96">
      <h3 class="text-lg font-bold text-cyber-accent mb-3">Manage Projects</h3>
      <div id="projectsList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
        <!-- Projects will be listed here -->
      </div>
      <button id="closeManageProjectsBtn" class="w-full px-3 py-1.5 bg-cyber-surface border border-cyber-text/20 rounded hover:bg-cyber-text/10 text-cyber-text text-sm">
        Close
      </button>
    </div>
  </div>

  <script>
    let currentFilter = 'all';
    let latestScanData = null;

    const criticalCountEl = document.getElementById('criticalCount');
    const warningCountEl = document.getElementById('warningCount');
    const depsCountEl = document.getElementById('depsCount');
    const lastScanEl = document.getElementById('lastScan');
    const issuesContainerEl = document.getElementById('issuesContainer');
    const runScanBtn = document.getElementById('runScanBtn');
    const projectSelector = document.getElementById('projectSelector');
    const addProjectBtn = document.getElementById('addProjectBtn');
    const manageProjectsBtn = document.getElementById('manageProjectsBtn');
    const addProjectModal = document.getElementById('addProjectModal');
    const manageProjectsModal = document.getElementById('manageProjectsModal');
    const projectPathInput = document.getElementById('projectPath');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const cancelProjectBtn = document.getElementById('cancelProjectBtn');
    const closeManageProjectsBtn = document.getElementById('closeManageProjectsBtn');
    const projectsList = document.getElementById('projectsList');
    const globalWatchToggle = document.getElementById('globalWatchToggle');
    const watchIndicator = document.getElementById('watchIndicator');
    const watchStatusText = document.getElementById('watchStatusText');

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-cyber-accent/20', 'border-cyber-accent', 'text-cyber-accent'));
        btn.classList.add('active', 'bg-cyber-accent/20', 'border-cyber-accent', 'text-cyber-accent');
        currentFilter = btn.dataset.filter;
        if (latestScanData) {
          renderIssues(latestScanData);
        }
      });
    });

    // Run scan manually
    runScanBtn.addEventListener('click', async () => {
      runScanBtn.disabled = true;
      runScanBtn.innerHTML = '‚è≥ Scanning...';
      
      const result = await window.electronAPI.runScan();
      if (result) {
        handleScanResult(result);
      }
      
      runScanBtn.disabled = false;
      runScanBtn.innerHTML = '‚ö° Run Scan Now';
    });

    // Format file path for display
    function formatFilePath(filepath) {
      const parts = filepath.split('/');
      if (parts.length > 4) {
        return '.../' + parts.slice(-3).join('/');
      }
      return filepath;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Copy to clipboard function
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì';
        button.classList.add('bg-cyber-accent/30');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-cyber-accent/30');
        }, 1500);
      }).catch(err => {
        console.error('Failed to copy:', err);
        button.innerHTML = '‚úó';
        setTimeout(() => {
          button.innerHTML = 'üìã';
        }, 1500);
      });
    }

    // Render issues
    function renderIssues(data) {
      latestScanData = data;
      
      let issues = [];
      
      if (currentFilter === 'all' || currentFilter === 'critical') {
        issues.push(...(data.critical || []).map(item => ({ ...item, type: 'critical' })));
      }
      
      if (currentFilter === 'all' || currentFilter === 'warning') {
        issues.push(...(data.warning || []).map(item => ({ ...item, type: 'warning' })));
      }
      
      if (currentFilter === 'all' || currentFilter === 'dependencies') {
        issues.push(...(data.dependencies || []).map(item => ({ ...item, type: 'dependencies' })));
      }

      if (issues.length === 0) {
        issuesContainerEl.innerHTML = `
          <div class="text-center py-20 text-cyber-accent">
            <div class="text-6xl mb-4">‚úÖ</div>
            <p class="text-xl font-bold glow-text">All Clear!</p>
            <p class="text-sm mt-2 text-cyber-text/60">No ${currentFilter === 'all' ? '' : currentFilter} issues detected</p>
          </div>
        `;
        return;
      }

      issuesContainerEl.innerHTML = issues.map(issue => {
        const colors = {
          critical: { bg: 'bg-cyber-danger/5', border: 'border-cyber-danger/30', text: 'text-cyber-danger', badge: 'bg-cyber-danger/20' },
          warning: { bg: 'bg-cyber-warning/5', border: 'border-cyber-warning/30', text: 'text-cyber-warning', badge: 'bg-cyber-warning/20' },
          dependencies: { bg: 'bg-blue-400/5', border: 'border-blue-400/30', text: 'text-blue-400', badge: 'bg-blue-400/20' }
        }[issue.type];

        const icon = {
          critical: 'üö®',
          warning: '‚ö†Ô∏è',
          dependencies: 'üì¶'
        }[issue.type];

        if (issue.type === 'dependencies') {
          return `
            <div class="relative ${colors.bg} backdrop-blur-sm border ${colors.border} rounded-lg p-3 hover:${colors.border.replace('/30', '/50')} transition-all">
              <div class="flex items-start gap-2">
                <div class="text-xl">${icon}</div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="px-2 py-0.5 ${colors.badge} ${colors.text} text-xs font-bold uppercase rounded">
                      ${issue.type}
                    </span>
                    <span class="text-xs ${colors.text} opacity-60">${issue.package_type || 'N/A'}</span>
                  </div>
                  <p class="font-bold ${colors.text} text-sm mb-1">${issue.package || 'Unknown Package'}</p>
                  <p class="text-xs text-cyber-text/80 break-words">${issue.description || 'No description'}</p>
                </div>
              </div>
            </div>
          `;
        }

        return `
          <div class="relative ${colors.bg} backdrop-blur-sm border ${colors.border} rounded-lg p-3 hover:${colors.border.replace('/30', '/50')} transition-all">
            <div class="flex items-start gap-2">
              <div class="text-xl">${icon}</div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2 group">
                  <span class="px-2 py-0.5 ${colors.badge} ${colors.text} text-xs font-bold uppercase rounded shrink-0">
                    ${issue.type}
                  </span>
                  <p class="text-xs text-cyber-text/60 font-mono truncate flex-1" title="${issue.file}">
                    üìÑ ${formatFilePath(issue.file || 'Unknown file')}
                  </p>
                  <button 
                    onclick="copyToClipboard('${escapeHtml(issue.file || '')}', this)" 
                    class="opacity-0 group-hover:opacity-100 transition-opacity px-1.5 py-0.5 bg-cyber-accent/10 hover:bg-cyber-accent/20 border border-cyber-accent/30 rounded text-cyber-accent text-xs shrink-0"
                    title="Copy file path">
                    üìã
                  </button>
                </div>
                <p class="text-xs text-cyber-text/80 break-words">${issue.description || 'No description'}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load projects
    async function loadProjects() {
      const { projects, activeProjectId } = await window.electronAPI.getProjects();
      
      projectSelector.innerHTML = projects.length === 0 
        ? '<option value="">No projects - Click + to add</option>'
        : '';
      
      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = `${project.name} (${project.path})`;
        if (project.id === activeProjectId) {
          option.selected = true;
        }
        projectSelector.appendChild(option);
      });
    }

    // Project selector change
    projectSelector.addEventListener('change', async (e) => {
      const projectId = e.target.value;
      if (projectId) {
        await window.electronAPI.setActiveProject(projectId);
      }
    });

    // Add project modal
    addProjectBtn.addEventListener('click', () => {
      addProjectModal.classList.remove('hidden');
      projectPathInput.value = '';
      projectPathInput.focus();
    });

    cancelProjectBtn.addEventListener('click', () => {
      addProjectModal.classList.add('hidden');
    });

    saveProjectBtn.addEventListener('click', async () => {
      const path = projectPathInput.value.trim();
      
      if (!path) {
        alert('Please enter a project path');
        return;
      }
      
      await window.electronAPI.addProject(path);
      await loadProjects();
      addProjectModal.classList.add('hidden');
      
      // Run scan for new project
      const result = await window.electronAPI.runScan();
      if (result) {
        handleScanResult(result);
      }
    });

    // Manage projects modal
    manageProjectsBtn.addEventListener('click', async () => {
      await renderProjectsList();
      manageProjectsModal.classList.remove('hidden');
    });

    closeManageProjectsBtn.addEventListener('click', () => {
      manageProjectsModal.classList.add('hidden');
    });

    async function renderProjectsList() {
      const { projects, activeProjectId } = await window.electronAPI.getProjects();
      
      if (projects.length === 0) {
        projectsList.innerHTML = '<p class="text-cyber-text/60 text-sm text-center py-4">No projects yet</p>';
        return;
      }
      
      projectsList.innerHTML = projects.map(project => `
        <div class="bg-cyber-bg border ${project.id === activeProjectId ? 'border-cyber-accent' : 'border-cyber-text/20'} rounded p-2">
          <div class="flex items-center justify-between mb-2">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-semibold ${project.id === activeProjectId ? 'text-cyber-accent' : 'text-cyber-text'}">${escapeHtml(project.name)}</p>
              <p class="text-xs text-cyber-text/60 font-mono truncate">${escapeHtml(project.path)}</p>
            </div>
            <button onclick="deleteProject('${project.id}')" class="ml-2 px-2 py-1 bg-cyber-danger/20 border border-cyber-danger/30 rounded text-cyber-danger text-xs hover:bg-cyber-danger/30">
              Delete
            </button>
          </div>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-2 cursor-pointer flex-1">
              <input 
                type="checkbox" 
                ${project.watchEnabled ? 'checked' : ''} 
                onchange="toggleProjectWatch('${project.id}', this.checked)"
                class="w-4 h-4 bg-cyber-bg border border-cyber-accent/30 rounded checked:bg-cyber-accent cursor-pointer"
              />
              <span class="text-xs ${project.watchEnabled ? 'text-cyber-accent' : 'text-cyber-text/60'}">
                Watch Enabled
              </span>
            </label>
          </div>
        </div>
      `).join('');
    }

    async function deleteProject(projectId) {
      if (confirm('Are you sure you want to delete this project?')) {
        await window.electronAPI.deleteProject(projectId);
        await loadProjects();
        await renderProjectsList();
      }
    }

    async function toggleProjectWatch(projectId, enabled) {
      await window.electronAPI.toggleProjectWatch(projectId, enabled);
      await renderProjectsList();
    }

    // Global watch toggle
    let globalWatchEnabled = true;
    
    async function updateGlobalWatchUI() {
      globalWatchEnabled = await window.electronAPI.getGlobalWatch();
      
      if (globalWatchEnabled) {
        globalWatchToggle.textContent = 'Watch: ON';
        globalWatchToggle.classList.remove('bg-cyber-danger/20', 'border-cyber-danger/50');
        globalWatchToggle.classList.add('bg-cyber-accent/20', 'border-cyber-accent/50');
        watchIndicator.classList.remove('bg-cyber-danger');
        watchIndicator.classList.add('bg-cyber-accent', 'card-glow');
        watchStatusText.textContent = 'Active';
      } else {
        globalWatchToggle.textContent = 'Watch: OFF';
        globalWatchToggle.classList.remove('bg-cyber-accent/20', 'border-cyber-accent/50');
        globalWatchToggle.classList.add('bg-cyber-danger/20', 'border-cyber-danger/50');
        watchIndicator.classList.remove('bg-cyber-accent', 'card-glow');
        watchIndicator.classList.add('bg-cyber-danger');
        watchStatusText.textContent = 'Stopped';
      }
    }

    globalWatchToggle.addEventListener('click', async () => {
      globalWatchEnabled = !globalWatchEnabled;
      await window.electronAPI.setGlobalWatch(globalWatchEnabled);
      await updateGlobalWatchUI();
    });

    // Handle scan result
    function handleScanResult(data) {
      // Update counts
      criticalCountEl.textContent = data.critical?.length || 0;
      warningCountEl.textContent = data.warning?.length || 0;
      depsCountEl.textContent = data.dependencies?.length || 0;
      
      // Update last scan time
      const now = new Date();
      lastScanEl.textContent = now.toLocaleTimeString();
      
      // Render issues
      renderIssues(data);
    }

    // Listen for scan results from main process
    window.electronAPI.onScanResult((data) => {
      console.log('Scan result received:', data);
      handleScanResult(data);
    });

    // Initialize
    setTimeout(async () => {
      await updateGlobalWatchUI();
      await loadProjects();
      
      const result = await window.electronAPI.runScan();
      if (result) {
        handleScanResult(result);
      }
    }, 1000);
  </script>
</body>
</html>
